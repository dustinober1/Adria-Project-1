// Prisma Schema for Adria Cross Website - Authentication & RBAC
// Sprint 2: User Authentication System

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["metrics", "tracing"]
  binaryTargets   = ["native", "debian-openssl-3.0.x"] // For Docker compatibility
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and authorization
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed password (bcrypt)
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  role      UserRole @default(CLIENT)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  refreshTokens RefreshToken[]
  blogPosts     BlogPost[]
  formSubmissions FormSubmission[]

  @@map("users")
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
}

// User role enum for RBAC
enum UserRole {
  CLIENT       // Regular client users
  ADMIN        // Admin users with elevated privileges
  SUPER_ADMIN  // Super admin with full system access
}

// RefreshToken model for JWT refresh token management
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Service offerings for styling engagements
model Service {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  description     String
  durationMinutes Int      @map("duration_minutes")
  priceCents      Int      @map("price_cents")
  active          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  formTemplates FormTemplate[]

  @@map("services")
  @@index([active])
  @@index([slug])
  @@index([createdAt])
}

// Blog posts / content pieces
model BlogPost {
  id            String         @id @default(uuid())
  title         String
  slug          String         @unique
  excerpt       String
  content       String
  featuredImage String?        @map("featured_image")
  status        BlogPostStatus @default(DRAFT)
  publishedAt   DateTime?      @map("published_at")
  authorId      String         @map("author_id")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  author User @relation(fields: [authorId], references: [id])

  @@map("blog_posts")
  @@index([status])
  @@index([slug])
  @@index([createdAt])
}

// Post publication statuses
enum BlogPostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model ContactInquiry {
  id              String         @id @default(uuid())
  fullName        String         @map("full_name")
  email           String
  phone           String?
  serviceInterest String?        @map("service_interest")
  message         String
  status          InquiryStatus  @default(NEW)
  metadata        Json?
  respondedAt     DateTime?      @map("responded_at")
  closedAt        DateTime?      @map("closed_at")
  adminNotes      String?        @map("admin_notes")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("contact_inquiries")
  @@index([status])
  @@index([createdAt])
  @@index([email, createdAt])
}

enum InquiryStatus {
  NEW
  IN_PROGRESS
  RESPONDED
  CLOSED
}

model FormTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  serviceId   String?  @map("service_id")
  service     Service? @relation(fields: [serviceId], references: [id])
  version     Int      @default(1)
  fields      Json
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  submissions FormSubmission[]

  @@map("form_templates")
  @@index([active])
  @@index([serviceId])
}

model FormSubmission {
  id              String        @id @default(uuid())
  formTemplateId  String        @map("form_template_id")
  formTemplate    FormTemplate  @relation(fields: [formTemplateId], references: [id])
  templateVersion Int           @map("template_version")
  userId          String?       @map("user_id")
  user            User?         @relation(fields: [userId], references: [id])
  email           String?
  responses       Json
  metadata        Json?
  createdAt       DateTime      @default(now()) @map("created_at")

  @@map("form_submissions")
  @@index([formTemplateId])
  @@index([createdAt])
  @@index([email, createdAt])
}
